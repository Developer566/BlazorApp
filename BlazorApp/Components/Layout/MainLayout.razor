@inherits LayoutComponentBase
@using BlazorApp.Components.Shared
@using BlazorApp.Services
@inject AuthService AuthService
@inject NavigationManager Nav

@if (Nav.Uri.Contains("/login") || Nav.Uri.Contains("/register-user"))
{
    @* 👆 Dono pages bغیر login ke accessible hone chahiye *@
    @Body
}
else
{
    @if (!AuthService.IsLoggedIn)
    {
        Nav.NavigateTo("/login");
    }
    else
    {
        <div class="page">
            <div class="sidebar">
                <NavMenu />
            </div>
            <main>
                <div class="top-row px-4">
                    <TopBar />
                </div>
                <article class="content px-4">
                    @Body
                </article>
            </main>
        </div>
        <div id="blazor-error-ui" data-nosnippet>
            An unhandled error has occurred.
            <a href="." class="reload">Reload</a>
            <span class="dismiss">🗙</span>
        </div>
        <Toast />
    }
}

@code {
    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (!AuthService.IsLoggedIn 
            && !e.Location.Contains("/login")
            && !e.Location.Contains("/register-user"))
        // 👆 Register-user page bhi allow karo
        {
            Nav.NavigateTo("/login");
        }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}