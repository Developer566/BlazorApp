@page "/members"
@rendermode InteractiveServer
@using BlazorApp.Data
@using BlazorApp.Models
@using BlazorApp.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject ToastService ToastService
@inject ExportService ExportService
@inject AuthService AuthService
@inject IJSRuntime JS

<PageTitle>Members</PageTitle>

@if (isToastVisible)
{
    <div style="position:fixed; top:20px; right:20px; z-index:9999; min-width:300px;"
        class="alert alert-success alert-dismissible shadow" role="alert">
        <strong>@toastMessage</strong>
        <button type="button" class="btn-close" @onclick="() => isToastVisible = false"></button>
    </div>
}

<h3>All Members</h3>
@if (AuthService.IsAdmin)
{
    <a href="/register" class="btn btn-success mb-3">+ Add New Member</a>
    <button class="btn btn-danger mb-3 ms-2" @onclick="ExportPdf">‚¨á Export PDF</button>
    <button class="btn btn-info mb-3 ms-2" @onclick="ExportExcel">‚¨á Export Excel</button>
}
@if (members == null)
{
    <p>Loading...</p>
}
else if (!members.Any())
{
    <p>No members found.</p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <label class="me-2">Show</label>
            <select class="form-select form-select-sm d-inline w-auto" @onchange="HandlePageSizeChange">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <label class="ms-2">entries</label>
        </div>

        <div class="w-50">
            <input type="text" class="form-control form-control-sm" placeholder="Search by name or membership..."
                @oninput="HandleSearch" />
        </div>
    </div>
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Photo</th>
                <th>Id</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Membership</th>
                <th>Registered</th>
                @if (AuthService.IsAdmin)
                {
                    <th>Actions</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var m in pagedMembers)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(m.PhotoPath))
                        {
                            <img src="/uploads/@m.PhotoPath" style="width:100px; height:100px; object-fit:cover; border-radius:50%;" />
                        }
                    </td>
                    <td>@m.Id</td>
                    <td>@m.FullName</td>
                    <td>@m.Email</td>
                    <td>@m.Phone</td>
                    <td>@m.MembershipType</td>
                    <td>@m.RegisteredDate.ToString("yyyy-MM-dd")</td>
                    @if (AuthService.IsAdmin)
                    {
                        <td>
                            <a href="/edit/@m.Id" class="btn btn-warning btn-sm">Edit</a>
                            <button class="btn btn-danger btn-sm" @onclick="() => ShowConfirm(m.Id, m.FullName)">Delete</button>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
    <!-- Confirmation Dialog -->
    @if (showConfirm)
    {
        <div
            style="position:fixed; top:0; left:0; width:100%; height:100%; 
                                                                                        background:rgba(0,0,0,0.5); z-index:9998;">
            <div
                style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
                                                                                            background:white; padding:30px; border-radius:10px; 
                                                                                            z-index:9999; min-width:350px; text-align:center; box-shadow: 0 5px 30px rgba(0,0,0,0.3);">
                <h4>‚ö†Ô∏è Confirm Delete</h4>
                <p>Are you sure you want to delete <strong>@confirmMemberName</strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
                <button class="btn btn-danger me-3" @onclick="ConfirmDelete">Yes, Delete</button>
                <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
            </div>
        </div>
    }
    <!-- Pagination Controls -->
    <nav>
        <ul class="pagination">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="PrevPage">Previous</button>
            </li>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNum = i;
                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="NextPage">Next</button>
            </li>
        </ul>
    </nav>

    <p class="text-muted">
        Showing @((currentPage - 1) * pageSize + 1) to @(Math.Min(currentPage * pageSize, members.Count)) of @members.Count
        members
    </p>
}

@code {
    private List<Member>? members;
    private List<Member> pagedMembers = new();
    private List<Member> filteredMembers = new();
    private bool isToastVisible = false;
    private string toastMessage = "";
    private bool showConfirm = false;
    private string searchText = "";
    private int memberToDeleteId;
    private string confirmMemberName = "";
    // Pagination
    private int currentPage = 1;
    private int pageSize = 5; // change to 10 if you want
    private int totalPages => (int)Math.Ceiling((filteredMembers?.Count ?? 0) / (double)pageSize);

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsLoggedIn)
        {
            Nav.NavigateTo("/login");
            return;
        }
        await LoadMembers();
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ToastService.PendingMessage != null)
        {
            toastMessage = ToastService.PendingMessage;
            ToastService.PendingMessage = null;
            isToastVisible = true;
            StateHasChanged();

            await Task.Delay(3000);
            isToastVisible = false;
            StateHasChanged();
        }
    }

    private async Task LoadMembers()
    {
        using var db = DbFactory.CreateDbContext();
        // üëÜ Factory se DbContext banao
        members = await db.Members.ToListAsync();
        filteredMembers = members;
        UpdatePagedMembers();
    }

    private void UpdatePagedMembers()
    {
        pagedMembers = filteredMembers!
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();
    }

    private void GoToPage(int pageNum)
    {
        currentPage = pageNum;
        UpdatePagedMembers();
    }

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagedMembers();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagedMembers();
        }
    }
    private void ShowConfirm(int id, string name)
    {
        memberToDeleteId = id;
        confirmMemberName = name;
        showConfirm = true;
    }
    private void CancelDelete()
    {
        showConfirm = false;
        memberToDeleteId = 0;
        confirmMemberName = "";
    }
    private async Task ConfirmDelete()
    {
        showConfirm = false;
        await DeleteMember(memberToDeleteId);
    }
    private async Task DeleteMember(int id)
    {
        using var db = DbFactory.CreateDbContext();
        var member = await db.Members.FindAsync(id);
        if (member != null)
        {
            db.Members.Remove(member);
            await db.SaveChangesAsync();
            await LoadMembers();
            toastMessage = "üóëÔ∏è Member deleted successfully!";
            isToastVisible = true;
            StateHasChanged();
            await Task.Delay(3000);
            isToastVisible = false;
            StateHasChanged();
        }
    }
    private async Task ExportExcel()
    {
        var data = ExportService.ExportToExcel(members!);
        await JS.InvokeVoidAsync("downloadFile", "Members.xlsx",
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        data);
    }

    private async Task ExportPdf()
    {
        var data = ExportService.ExportToPdf(members!);
        await JS.InvokeVoidAsync("downloadFile", "Members.pdf", "application/pdf", data);
    }
    private void Search()
    {
        if (string.IsNullOrEmpty(searchText))
        {
            filteredMembers = members!;
        }
        else
        {
            filteredMembers = members!.Where(m =>
            m.FullName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            m.MembershipType.Contains(searchText, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }
        currentPage = 1;
        UpdatePagedMembers();
    }
    private void HandleSearch(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        Search();
    }
    private void HandlePageSizeChange(ChangeEventArgs e)
    {
        pageSize = int.Parse(e.Value?.ToString() ?? "5");

        currentPage = 1;

        UpdatePagedMembers();
    }
}