@page "/members"
@rendermode InteractiveServer
@using BlazorApp.Data
@using BlazorApp.Models
@using BlazorApp.Services
@using Microsoft.EntityFrameworkCore
@inject AppDbContext db
@inject NavigationManager Nav
@inject ToastService ToastService
@inject ExportService ExportService
@inject IJSRuntime JS
@if (isToastVisible)
{
    <div style="position:fixed; top:20px; right:20px; z-index:9999; min-width:300px;"
        class="alert alert-success alert-dismissible shadow" role="alert">
        <strong>@toastMessage</strong>
        <button type="button" class="btn-close" @onclick="() => isToastVisible = false"></button>
    </div>
}

<h3>All Members</h3>
<a href="/register" class="btn btn-success mb-3">+ Add New Member</a>
<button class="btn btn-danger mb-3 ms-2" @onclick="ExportPdf">‚¨á Export PDF</button>
<button class="btn btn-success mb-3 ms-2" @onclick="ExportExcel">‚¨á Export Excel</button>
@if (members == null)
{
    <p>Loading...</p>
}
else if (!members.Any())
{
    <p>No members found.</p>
}
else
{
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Id</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Membership</th>
                <th>Registered</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in pagedMembers)
            {
                <tr>
                    <td>@m.Id</td>
                    <td>@m.FullName</td>
                    <td>@m.Email</td>
                    <td>@m.Phone</td>
                    <td>@m.MembershipType</td>
                    <td>@m.RegisteredDate.ToString("yyyy-MM-dd")</td>
                    <td>
                        <a href="/edit/@m.Id" class="btn btn-warning btn-sm">Edit</a>
                        <button class="btn btn-danger btn-sm" @onclick="() => ShowConfirm(m.Id, m.FullName)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <!-- Confirmation Dialog -->
    @if (showConfirm)
    {
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; 
                                        background:rgba(0,0,0,0.5); z-index:9998;">
            <div
                style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
                                            background:white; padding:30px; border-radius:10px; 
                                            z-index:9999; min-width:350px; text-align:center; box-shadow: 0 5px 30px rgba(0,0,0,0.3);">
                <h4>‚ö†Ô∏è Confirm Delete</h4>
                <p>Are you sure you want to delete <strong>@confirmMemberName</strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
                <button class="btn btn-danger me-3" @onclick="ConfirmDelete">Yes, Delete</button>
                <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
            </div>
        </div>
    }
    <!-- Pagination Controls -->
    <nav>
        <ul class="pagination">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="PrevPage">Previous</button>
            </li>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNum = i;
                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="NextPage">Next</button>
            </li>
        </ul>
    </nav>

    <p class="text-muted">
        Showing @((currentPage - 1) * pageSize + 1) to @(Math.Min(currentPage * pageSize, members.Count)) of @members.Count
        members
    </p>
}

@code {
    private List<Member>? members;
    private List<Member> pagedMembers = new();

    private bool isToastVisible = false;
    private string toastMessage = "";
    private bool showConfirm = false;
    private int memberToDeleteId;
    private string confirmMemberName = "";
    // Pagination
    private int currentPage = 1;
    private int pageSize = 5; // change to 10 if you want
    private int totalPages => (int)Math.Ceiling((members?.Count ?? 0) / (double)pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadMembers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ToastService.PendingMessage != null)
        {
            toastMessage = ToastService.PendingMessage;
            ToastService.PendingMessage = null;
            isToastVisible = true;
            StateHasChanged();

            await Task.Delay(3000);
            isToastVisible = false;
            StateHasChanged();
        }
    }

    private async Task LoadMembers()
    {
        members = await db.Members.ToListAsync();
        UpdatePagedMembers();
    }

    private void UpdatePagedMembers()
    {
        pagedMembers = members!
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();
    }

    private void GoToPage(int pageNum)
    {
        currentPage = pageNum;
        UpdatePagedMembers();
    }

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagedMembers();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagedMembers();
        }
    }
    private void ShowConfirm(int id, string name)
    {
        memberToDeleteId = id;
        confirmMemberName = name;
        showConfirm = true;
    }
    private void CancelDelete()
    {
        showConfirm = false;
        memberToDeleteId = 0;
        confirmMemberName = "";
    }
    private async Task ConfirmDelete()
    {
        showConfirm = false;
        await DeleteMember(memberToDeleteId);
    }
    private async Task DeleteMember(int id)
    {
        var member = await db.Members.FindAsync(id);
        if (member != null)
        {
            db.Members.Remove(member);
            await db.SaveChangesAsync();
            await LoadMembers();
            toastMessage = "üóëÔ∏è Member deleted successfully!";
            isToastVisible = true;
            StateHasChanged();

            await Task.Delay(3000);
            isToastVisible = false;
            StateHasChanged();
        }
    }
    private async Task ExportExcel()
    {
        var data = ExportService.ExportToExcel(members!);
        await JS.InvokeVoidAsync("downloadFile", "Members.xlsx",
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        data);
    }

    private async Task ExportPdf()
    {
        var data = ExportService.ExportToPdf(members!);
        await JS.InvokeVoidAsync("downloadFile", "Members.pdf", "application/pdf", data);
    }
}