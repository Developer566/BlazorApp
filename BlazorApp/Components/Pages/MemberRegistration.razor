@page "/register"
@rendermode InteractiveServer
@using BlazorApp.Data
@using BlazorApp.Models
@using BlazorApp.Services
@inject AppDbContext db
@inject NavigationManager Nav
@inject ToastService ToastService;
@inject EmailService EmailService;
@using Microsoft.EntityFrameworkCore
@inject IWebHostEnvironment Env 
@inject IDbContextFactory<AppDbContext> DbFactory
<PageTitle>Registration</PageTitle>
<h3>Member Registration</h3>

<EditForm Model="@member" OnValidSubmit="HandleValidSubmit" FormName="MemberRegistrationForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Full Name</label><br />
        <InputText @bind-Value="member.FullName" placeholder="Enter full name" class="form-control" />
    </div>
    <br />

    <div>
        <label>Email</label><br />
        <InputText @bind-Value="member.Email" placeholder="Enter email" class="form-control" />
    </div>
    <br />

    <div>
        <label>Phone</label><br />
        <InputText @bind-Value="member.Phone" placeholder="Enter phone number" class="form-control" />
    </div>
    <br />

    <div>
        <label>Membership Type</label><br />
        <InputSelect @bind-Value="member.MembershipType" class="form-control">
            <option value="">-- Select Type --</option>
            <option value="Basic">Basic</option>
            <option value="Premium">Premium</option>
            <option value="VIP">VIP</option>
        </InputSelect>
    </div>
    @* Image upload field *@
    <div class="mb-3">
        <label class="form-label">Profile Photo</label>
        <InputFile OnChange="HandleFileUpload" class="form-control" accept="image/*" />
        @* ðŸ‘† InputFile = Blazor ka file input component
       OnChange = file select hone pe method call karo
       accept="image/*" = sirf images allow karo *@
    </div>

    @* Preview *@
    @if (!string.IsNullOrEmpty(member.PhotoPath))
    {
        <img src="/uploads/@member.PhotoPath" style="width:100px; height:100px; object-fit:cover; border-radius:50%;" />
        @* ðŸ‘† Preview dikhao â€” circle shape mein *@
    }
    <br />

    <button type="submit" class="btn btn-info">Register</button>
</EditForm>

@if (successMessage != "")
{
    <p style="color:green; font-weight:bold;">@successMessage</p>
}

@code {
    private Member member = new Member();
    private string successMessage = "";
    private IBrowserFile? selectedFile;
    // ðŸ‘† Selected file store karne ke liye

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        // ðŸ‘† File store karo â€” abhi save nahi karein ge
        // Save tab karein ge jab form submit ho
    }
    private async Task HandleValidSubmit()
    {
        using var db = DbFactory.CreateDbContext();
        db.Members.Add(member);

        if (selectedFile != null)
        {
            var extension = Path.GetExtension(selectedFile.Name);
            // ðŸ‘† File extension lo â€” .jpg, .png etc

            var fileName = $"{Guid.NewGuid()}{extension}";
            // ðŸ‘† Unique name banao â€” "abc123-def456.jpg"
            // Guid = globally unique identifier

            var path = Path.Combine(Env.WebRootPath, "uploads", fileName);
            // ðŸ‘† Full path â€” wwwroot/uploads/abc123.jpg

            using var stream = File.Create(path);
            await selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);
            // ðŸ‘† File ko disk pe save karo
            // maxAllowedSize = 5MB maximum

            member.PhotoPath = fileName;
            // ðŸ‘† Sirf file name database mein save karo
        }
        await db.SaveChangesAsync();

        // âœ… Sirf Member ko welcome email
        try
        {
            await EmailService.SendMemberWelcomeAsync(
            member.Email,
            member.FullName,
            member.MembershipType // âœ… yeh add karo
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Email error: {ex.Message}");
        }

        ToastService.QueueSuccess($"âœ… {member.FullName} registered successfully!");
        Nav.NavigateTo("/members");
    }
}