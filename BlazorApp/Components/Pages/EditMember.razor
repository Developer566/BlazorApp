@page "/edit/{id:int}"
@rendermode InteractiveServer
@using BlazorApp.Data
@using BlazorApp.Models
@using BlazorApp.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject ToastService ToastService
@inject IWebHostEnvironment Env

<PageTitle>Edit Member Form</PageTitle>
<h3>Edit Member</h3>

@if (member == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="@member" OnValidSubmit="HandleUpdate" FormName="EditMemberForm">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label>Profile Photo</label><br />

            @* Current photo dikhao *@
            @if (!string.IsNullOrEmpty(member.PhotoPath))
            {
                <img src="/uploads/@member.PhotoPath" style="width:80px; height:80px; object-fit:cover; border-radius:50%;"
                    class="mb-2 d-block" />
                <small class="text-muted">Current photo â€” upload new to replace</small>
            }
            else
            {
                <span class="d-block mb-2">ðŸ‘¤ No photo</span>
            }

            <InputFile OnChange="HandleFileUpload" class="form-control mt-2" accept="image/*" />
        </div>
        <div>
            <label>Full Name</label><br />
            <InputText @bind-Value="member.FullName" class="form-control" />
        </div>
        <br />

        <div>
            <label>Email</label><br />
            <InputText @bind-Value="member.Email" class="form-control" />
        </div>
        <br />

        <div>
            <label>Phone</label><br />
            <InputText @bind-Value="member.Phone" class="form-control" />
        </div>
        <br />

        <div>
            <label>Membership Type</label><br />
            <InputSelect @bind-Value="member.MembershipType" class="form-control">
                <option value="">-- Select Type --</option>
                <option value="Basic">Basic</option>
                <option value="Premium">Premium</option>
                <option value="VIP">VIP</option>
            </InputSelect>
        </div>
        <br />

        <button type="submit" class="btn btn-primary">Update</button>
        <a href="/members" class="btn btn-secondary ms-2">Cancel</a>
    </EditForm>

    @if (successMessage != "")
    {
        <p style="color:green; font-weight:bold;">@successMessage</p>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private Member? member;
    private string successMessage = "";

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        member = await db.Members.FindAsync(Id);
    }

    private async Task HandleUpdate()
    {
        using var db = DbFactory.CreateDbContext();

        if (selectedFile != null)
        {
            var extension = Path.GetExtension(selectedFile.Name);
            var fileName = $"{Guid.NewGuid()}{extension}";
            var path = Path.Combine(Env.WebRootPath, "uploads", fileName);

            using var stream = File.Create(path);
            await selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);

            member!.PhotoPath = fileName;
        }

        db.Members.Update(member!);
        await db.SaveChangesAsync();
        ToastService.QueueSuccess("âœ… Member updated successfully!");
        Nav.NavigateTo("/members");
    }
    private IBrowserFile? selectedFile;
    // ðŸ‘† Selected file store karne ke liye

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }
}